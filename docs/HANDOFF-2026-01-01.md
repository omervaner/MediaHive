# MediaHive Handoff Summary - January 1, 2026

## Project Overview
MediaHive is a desktop media management app for AI-generated content, forked from VideoSwarm. Built with Electron + Vite + React. User is Ã–mer (Istanbul), coding on MacBook Air 16GB, testing AI on Windows PC with RTX 5090.

**Repo:** `/Users/omer/Documents/Projects/MediaHive`

---

## What's Working âœ…

### Phase 2: Image Support
- Display images alongside videos in masonry grid
- EXIF-aware dimension extraction (iPhone photos correct)
- Media filter toggle: Images / Videos / All
- Fullscreen modal for both types

### Phase 2.5: Filtering & Export
- **Resolution filter:** 512+, 768+, 1024+, 2K+, 4K+
- **Aspect ratio filter:** Square, Portrait, Landscape
- **Screenshot detector:** Auto-detect with confidence scoring, filter toggle
- **Dataset export:** Export to LoRA training folders with .txt captions, supports musubi-tuner TOML and kohya JSON formats

### Phase 3: AI Captioning (Partial)
- Ollama detection with "Download Ollama" link to ollama.com
- 4-tier model picker: 2b (1.9GB), 4b (3.3GB), 8b (6.1GB), 32b (20GB)
- Model download with progress bar
- **Single image captioning works and persists** (from Details panel)
- Settings dialog with model management
- Cancel button + elapsed timer during generation
- AI-suggested tags with Save/Discard workflow

---

## Current Bugs ðŸ› (For CC to Fix)

### 1. ~~Batch Captioning Not Saving~~ âœ… FIXED
**Root cause:** Typo in App.jsx - `setRawVideos` instead of `setVideos` (two occurrences in BatchCaptionDialog callbacks).
**Fix:** Changed to `setVideos` in both `onComplete` and `onUpdateFile` callbacks.

### 2. ~~Progress Counter Wrong~~ âœ… FIXED
Counter/percent mismatch was due to different semantics (current vs completed). Now consistent.

### 3. App Crashes on External File Delete (Still open)
If user deletes a file from the folder while app is open, app crashes. File watcher needs graceful handling.

### 4. Timeout Implementation (Unverified)
CC added model-aware timeouts (60s/90s/120s/180s) but hasn't been verified working.

---

## On Hold â¸ï¸

- **Duplicate Finder** - pHash perceptual hashing
- **Quality Scorer** - blur/exposure detection

---

## Key Files

| File | Purpose |
|------|---------|
| `CLAUDE.md` | Working doc for CC - conventions, current tasks |
| `docs/CHANGELOG.md` | Completed features history |
| `docs/PHASE3-AI-CAPTIONING.md` | Full Phase 3 spec with UI mockups |
| `main/ollamaService.js` | Ollama detection, model pull |
| `main/captionService.js` | Caption generation, batch processing |
| `main/database.js` | SQLite with new captions table |
| `src/components/MetadataPanel.jsx` | Details panel with caption UI |
| `src/components/BatchCaptionDialog.jsx` | Batch captioning dialog |
| `src/components/OllamaSetupDialog.jsx` | First-run model setup |
| `src/components/SettingsDialog.jsx` | Settings with model management |

---

## Testing Setup

**Ollama:** Installed via `brew install ollama`, run with `ollama serve`
**Models downloaded:** qwen3-vl:2b, qwen3-vl:4b (user has both)
**Test folder:** User has a TestImage folder with 3 images for quick testing

---

## Next Steps (Priority Order)

1. ~~**Fix batch caption persistence**~~ âœ… Done
2. ~~**Fix progress counter**~~ âœ… Done
3. **Fix skip logic** - Skip files that already have tags when "overwrite" is unchecked
4. **Fix crash on file delete** - Graceful file watcher handling
5. **Verify timeouts work** - Test that stuck images move on after timeout
6. **Step 6: Export integration** - Use AI captions in dataset export

---

## Commands

```bash
cd /Users/omer/Documents/Projects/MediaHive
npm run electron:dev   # Development mode
npm test               # Run tests
```

---

## Session Notes

- 2b model is fastest but still ~30-60s per image on MacBook Air
- 8b model was too slow (2-3 min per image), user switched to 4b then 2b
- Individual caption from Details panel â†’ works and persists âœ…
- Batch caption â†’ broken, doesn't save âŒ
- Donate button removed (was from original VideoSwarm dev)

---

## Tell CC

> "Batch caption persistence and progress counter are fixed. Next task: fix the skip logic in BatchCaptionDialog.jsx. When 'overwrite' is unchecked, it currently only skips files with `aiCaption`. It should also skip files that already have `aiTags` if generating tags. The logic should be:
> - Generating captions only â†’ skip files with aiCaption
> - Generating tags only â†’ skip files with aiTags
> - Generating both â†’ skip files that have either
> 
> Also still need to fix the crash when files are deleted externally."
